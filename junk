// import React, { createContext, useState, useEffect, useContext } from 'react';

// // 1. Define the Context and its shape
// const SessionContext = createContext();

// // 2. Define the base URL for your PHP API
// // IMPORTANT: Update this to your actual backend endpoint!
// const API_BASE_URL = 'http://localhost/api';

// /**
//  * Custom hook for consuming the Session Context
//  * @returns {object} The session context state and methods
//  */
// export const useSession = () => useContext(SessionContext);

// /**
//  * Provider component that manages the session state and logic
//  * @param {object} props - Component props
//  * @param {React.ReactNode} props.children - Child elements to wrap
//  */
// export const SessionProvider = ({ children }) => {
//   const [user, setUser] = useState(null);
//   const [isAuthenticated, setIsAuthenticated] = useState(false);
//   // isLoading is crucial for waiting on initial session check
//   const [isLoading, setIsLoading] = useState(true);

//   // --- API Handlers ---

//   /**
//    * General fetch wrapper to handle JSON and basic errors
//    * @param {string} endpoint - The API endpoint (e.g., '/login')
//    * @param {object} options - Fetch options (method, headers, body, etc.)
//    * @returns {Promise<object>} The parsed JSON response data
//    */
//   const apiFetch = async (endpoint, options = {}) => {
//     try {
//       const response = await fetch(`${API_BASE_URL}${endpoint}`, {
//         ...options,
//         // Crucial for sending cookies/sessions
//         credentials: 'include',
//         headers: {
//           'Content-Type': 'application/json',
//           ...options.headers,
//         },
//       });

//       if (!response.ok) {
//         // Attempt to read error message from response body
//         const errorData = await response.json().catch(() => ({ message: 'Server error' }));
//         throw new Error(errorData.message || `HTTP error! Status: ${response.status}`);
//       }

//       return response.json();
//     } catch (error) {
//       console.error("API Fetch Error:", error.message);
//       // Re-throw to be handled by the calling function (e.g., login)
//       throw error;
//     }
//   };

//   /**
//    * Attempts to log in the user.
//    * @param {string} email - User's email
//    * @param {string} password - User's password
//    * @returns {Promise<object>} The user data on success.
//    */
//   const login = async (email, password) => {
//     setIsLoading(true);
//     try {
//       const data = await apiFetch('/login', {
//         method: 'POST',
//         body: JSON.stringify({ email, password }),
//       });

//       // Assuming PHP backend returns user data on successful login
//       const userData = data.user;
//       setUser(userData);
//       setIsAuthenticated(true);
//       return userData;

//     } catch (error) {
//       // Clear session state on failed login attempt
//       setUser(null);
//       setIsAuthenticated(false);
//       throw error; // Let the UI handle the error message
//     } finally {
//       setIsLoading(false);
//     }
//   };

//   /**
//    * Logs out the user.
//    */
//   const logout = async () => {
//     setIsLoading(true);
//     try {
//       await apiFetch('/logout', { method: 'POST' });
//       // Clear local state regardless of the backend response
//       setUser(null);
//       setIsAuthenticated(false);
//     } catch (error) {
//       // Log errors but still clear local session for safety
//       console.warn("Logout endpoint failed, but clearing local session.", error);
//     } finally {
//       setIsLoading(false);
//     }
//   };

//   /**
//    * Checks the session state on mount and update.
//    */
//   const checkSession = async () => {
//     setIsLoading(true);
//     try {
//       // Assuming PHP backend has a route like /me or /session that returns
//       // the current user data if logged in, or 401/empty JSON otherwise.
//       const data = await apiFetch('/me', { method: 'GET' });

//       // If data is successfully returned, the user is logged in
//       if (data && data.user) {
//         setUser(data.user);
//         setIsAuthenticated(true);
//       } else {
//         // Handle case where API returns a non-error status but no user data
//         setUser(null);
//         setIsAuthenticated(false);
//       }

//     } catch (error) {
//       // 401 Unauthorized or other network/server error means no session
//       setUser(null);
//       setIsAuthenticated(false);
//     } finally {
//       setIsLoading(false);
//     }
//   };

//   // Run the session check only once on component mount
//   useEffect(() => {
//     checkSession();
//   }, []);

//   // --- Context Value ---

//   const contextValue = {
//     user,
//     isAuthenticated,
//     isLoading,
//     login,
//     logout,
//     // Add checkSession if you need to manually trigger a refresh
//     checkSession,
//   };

//   return (
//     <SessionContext.Provider value={contextValue}>
//       {/* Don't render children until the initial session check is complete
//         This prevents UI flash/rendering components that require authentication
//         before we know the state. You might show a 'Loading...' spinner here.
//       */}
//       {!isLoading ? children : <div>Loading session...</div>}
//     </SessionContext.Provider>
//   );
// };

// export default SessionContext;

///////////////////////////////////////////////////////////////////////////////////////////

import React, { createContext, useState, useEffect, useContext } from "react";

// 1. Define Context and API endpoint
const SessionContext = createContext(null);
const API_BASE_URL = "http://localhost/api"; // <--- UPDATE THIS!

/**
 * Custom hook for consuming the Session Context
 */
export const useSession = () => useContext(SessionContext);

// --- Provider Component ---

export const SessionProvider = ({ children }) => {
  const [user, setUser] = useState(null);
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  // CRITICAL: Used to prevent UI flash before initial session check
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState(null);

  // --- API Utility Function ---

  /**
   * Performs an authenticated fetch request to the PHP backend.
   */
  const apiFetch = async (endpoint, options = {}) => {
    // Note: The URL assumes your PHP backend uses a routing system
    // (e.g., '/session', '/login') instead of individual files (e.g., 'session.php').
    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
      ...options,
      // CRITICAL: Must be 'include' for sending/receiving session cookies
      credentials: "include",
      headers: {
        "Content-Type": "application/json",
        ...options.headers,
      },
    });

    const data = await response
      .json()
      .catch(() => ({ message: "Server error: Invalid JSON response" }));

    if (!response.ok) {
      throw new Error(data.message || `HTTP error! Status: ${response.status}`);
    }

    return data;
  };

  // --- Authentication Functions ---

  /**
   * Checks the user's session state on the server.
   * Assumes PHP endpoint '/me' returns user data (200) or an error (401/403).
   */
  const checkSession = async () => {
    setIsLoading(true);
    try {
      // Endpoint: Get the currently logged-in user details
      const data = await apiFetch("/me", { method: "GET" });

      // If the API returns user data, the session is active
      if (data && data.user) {
        setUser(data.user);
        setIsAuthenticated(true);
      } else {
        // Logged out or server returned an unexpected structure
        setUser(null);
        setIsAuthenticated(false);
      }
    } catch (err) {
      // 401 Unauthorized or other failure means no active session
      setUser(null);
      setIsAuthenticated(false);
    } finally {
      setIsLoading(false);
    }
  };

  /**
   * Logs in the user.
   */
  const login = async (email, password) => {
    setError(null);
    setIsLoading(true);
    try {
      const data = await apiFetch("/login", {
        method: "POST",
        body: JSON.stringify({ email, password }),
      });

      const userData = data.user;
      setUser(userData);
      setIsAuthenticated(true);
      return userData;
    } catch (err) {
      setError(err.message);
      setUser(null);
      setIsAuthenticated(false);
      throw err;
    } finally {
      setIsLoading(false);
    }
  };

  /**
   * Logs out the user.
   */
  const logout = async () => {
    setIsLoading(true);
    try {
      // Endpoint: Invalidate the session on the server
      await apiFetch("/logout", { method: "POST" });
    } catch (err) {
      console.warn("Logout failed on server, but clearing local session.", err);
    } finally {
      // Always clear local state regardless of server response
      setUser(null);
      setIsAuthenticated(false);
      setIsLoading(false);
    }
  };

  // --- Initial Check on Mount ---

  useEffect(() => {
    checkSession();
  }, []);

  // --- Context Value ---

  const contextValue = {
    user,
    isAuthenticated,
    isLoading,
    error,
    login,
    logout,
    checkSession,
  };

  return (
    <SessionContext.Provider value={contextValue}>
      {/* This is the strengthening part: 
        We only render children AFTER we know the session state.
        Show a simple loading screen in the meantime.
      */}
      {!isLoading ? (
        children
      ) : (
        <div style={{ padding: "20px", textAlign: "center" }}>
          Initializing Application...
        </div>
      )}
    </SessionContext.Provider>
  );
};
